<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ 1447Ù‡Ù€</title>
<meta name="description" content="ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ 1447Ù‡Ù€">

<!-- âœ… Ø£Ù…Ø§Ù†: Ø³ÙŠØ§Ø³Ø© Ù…Ø­ØªÙˆÙ‰ Ù„ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø¹Ù„Ù‰ https/self ÙÙ‚Ø· -->
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' https: data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src 'self'; object-src 'none'">

<style>
  :root{
    /* ğŸ¨ Ù‡ÙˆÙŠØ© Ø®Ø¶Ø±Ø§Ø¡ */
    --primary:#1e7d32; --primary-2:#66bb6a; --bg:#f5fff5; --card:#ffffff;
    --ok:#1e7d32; --warn:#f9a825; --danger:#d32f2f; --muted:#64748b;
    --shadow:0 10px 22px rgba(0,0,0,.08); --radius:18px;
  }
  *,*::before,*::after{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#0f172a;font-family:'Tajawal',Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--primary),var(--primary-2));color:#fff;padding:14px 16px;box-shadow:var(--shadow)}
  .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:44px;height:44px;border-radius:50%;background:#fff;color:var(--primary);display:grid;place-items:center;font-weight:900}
  nav a{color:#fff;text-decoration:none;padding:8px 12px;border-radius:10px;font-weight:700;opacity:.95}
  nav a:hover{background:rgba(255,255,255,.18)}
  main{max-width:1100px;margin:18px auto;padding:0 14px;display:grid;gap:18px}
  .grid{display:grid;gap:18px}
  @media (min-width:900px){.grid{grid-template-columns:1.15fr 1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
  .card h3{margin:0 0 10px;font-size:1.12rem}
  .muted{color:var(--muted);font-size:.92rem}
  .btn{border:none;background:#eef7ee;padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800;box-shadow:var(--shadow)}
  .btn.primary{background:linear-gradient(180deg,#2e7d32,#66bb6a);color:#fff}
  .btn.ghost{background:#fff}
  .btn.ok{background:linear-gradient(180deg,#2e7d32,#81c784);color:#fff}
  .btn.warn{background:linear-gradient(180deg,#f9a825,#ffd54f)}
  .btn.danger{background:linear-gradient(180deg,#d32f2f,#ef5350);color:#fff}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .pill{background:#e8f5e9;color:#14532d;padding:4px 10px;border-radius:999px;font-size:.85rem}
  .alert{display:none;border-radius:12px;padding:10px;font-size:.92rem}
  .alert.show{display:block}
  .alert.error{background:#fdecea;color:#b71c1c;border:1px solid #ffcdd2}
  .alert.ok{background:#e8f5e9;color:#1b5e20;border:1px solid #c8e6c9}
  .footer{text-align:center;color:#9aa4b2;padding:16px}

  /* Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ */
  .student{display:grid;grid-template-columns:96px 1fr;gap:14px;align-items:center}
  .avatar{width:96px;height:96px;border-radius:16px;overflow:hidden;border:3px solid #e6ffe6;background:#fff}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .progress{height:10px;background:#e6f5e6;border-radius:999px;overflow:hidden}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,#2e7d32,#a5d6a7)}

  /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #e8f5e9;text-align:center}
  thead th{background:#f0fbf0}
  .slot{display:grid;gap:6px}
  .slot input,.slot select,.slot textarea{width:100%;padding:8px;border:1px solid #d6ead9;border-radius:10px}
  .slot textarea{min-height:60px;resize:vertical}

  /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ØµØºÙ‘Ø±Ø© */
  .activities{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .tile{border:1px solid #e5f6e5;border-radius:14px;box-shadow:var(--shadow);overflow:hidden;display:grid;grid-template-rows:140px 1fr;min-height:220px;background:#fff}
  .tile .ph{display:grid;place-items:center;color:#7a8b7c;background:#f6fff6}
  .tile img{width:100%;height:140px;object-fit:cover}
  .tile .body{padding:10px;display:grid;gap:6px}
  .meta{font-size:.8rem;color:#587261;display:flex;justify-content:space-between}

  /* Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª */
  .skills{display:grid;gap:8px}
  .skill{display:grid;grid-template-columns:1fr auto;align-items:center;gap:10px;padding:8px 10px;border:1px dashed #cfead3;border-radius:12px;background:#fcfffc}

  /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
  .report pre{white-space:pre-wrap;background:#0f172a;color:#e2e8f0;padding:12px;border-radius:12px;overflow:auto}

  /* Ø·Ø¨Ø§Ø¹Ø© */
  @media print{
    header, nav, #exportBtn, #importFile, #printBtn { display:none !important; }
    .card{box-shadow:none; border:1px solid #ddd}
    body{background:#fff}
  }
</style>
</head>
<body>
<header aria-label="Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ">
  <div class="row" style="justify-content:space-between">
    <div class="brand" aria-label="Ù‡ÙˆÙŠØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬">
      <div class="logo" aria-hidden="true">Ø£</div>
      <div>
        <div style="font-weight:900">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ 1447Ù‡Ù€</div>
        <div class="muted" id="todayLine">â€¦</div>
      </div>
    </div>
    <nav class="row" aria-label="Ø§Ù„ØªÙ†Ù‚Ù„">
      <a href="#student">Ø§Ù„Ø·Ø§Ù„Ø¨</a>
      <a href="#timetable">Ø§Ù„Ø¬Ø¯ÙˆÙ„</a>
      <a href="#skills">Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</a>
      <a href="#assignments">Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</a>
      <a href="#behavior">Ø§Ù„Ø³Ù„ÙˆÙƒ & Ø§Ù„Ù…ÙƒØ§ÙØ¢Øª</a>
      <a href="#report">Ø§Ù„ØªÙ‚Ø±ÙŠØ±</a>
    </nav>
  </div>
</header>

<main>
  <!-- ========== Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ========== -->
  <section id="student" class="card" aria-labelledby="student-title">
    <h3 id="student-title">Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
    <div class="alert error" id="errBox" role="alert"></div>
    <div class="student">
      <div class="avatar"><img id="avatar" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨" src="https://i.imgur.com/2yaf2wb.png"></div>
      <div>
        <div class="row" style="gap:8px">
          <input id="studentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" aria-label="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" autocomplete="off" minlength="2" style="padding:10px;border:1px solid #d6ead9;border-radius:12px;min-width:220px">
          <input id="studentImg" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (HTTPS ÙÙ‚Ø·)" aria-label="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" inputmode="url" style="padding:10px;border:1px solid #d6ead9;border-radius:12px;min-width:280px">
          <button class="btn primary" id="saveStudent">Ø­ÙØ¸</button>
          <span class="pill" id="saveOk" style="display:none">âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸</span>
        </div>
        <div class="row" style="justify-content:space-between;margin-top:8px">
          <span class="muted">Ù†Ø³Ø¨Ø© Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª</span>
          <span class="pill"><b id="skillPct">0</b>%</span>
        </div>
        <div class="progress" aria-label="Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…"><span id="progressBar" style="width:0%"></span></div>
      </div>
    </div>
  </section>

  <!-- ========== Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ ========== -->
  <section id="timetable" class="card">
    <h3>Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø§Ù„Ø£Ø­Ø¯â€“Ø§Ù„Ø®Ù…ÙŠØ³)</h3>
    <div class="muted" style="margin-bottom:8px">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø­ØµØ© ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ù‚ØµÙŠØ±Ø© Ù„ÙƒÙ„ ÙŠÙˆÙ…. ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</div>
    <div class="grid">
      <div class="card" style="padding:0">
        <table id="table">
          <thead><tr>
            <th>Ø§Ù„ÙŠÙˆÙ…</th>
            <th>Ø§Ù„Ø­ØµØ© 1</th><th>Ø§Ù„Ø­ØµØ© 2</th><th>Ø§Ù„Ø­ØµØ© 3</th><th>Ø§Ù„Ø­ØµØ© 4</th><th>Ø§Ù„Ø­ØµØ© 5</th>
          </tr></thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
      <div class="card" aria-label="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…">
        <h3>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
        <div class="slot">
          <label for="daySelect" class="muted">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…</label>
          <select id="daySelect" aria-label="Ø§Ù„ÙŠÙˆÙ…">
            <option>Ø§Ù„Ø£Ø­Ø¯</option><option>Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option><option>Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option><option>Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option><option>Ø§Ù„Ø®Ù…ÙŠØ³</option>
          </select>
          <label for="dayNotes" class="muted">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea id="dayNotes" placeholder="Ø³Ù„ÙˆÙƒ/Ø¥Ù†Ø¬Ø§Ø²/ØªÙ†Ø¨ÙŠÙ‡ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±â€¦"></textarea>
          <div class="row">
            <button class="btn primary" id="saveNotes">Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</button>
            <button class="btn ghost" id="clearNotes">Ù…Ø³Ø­</button>
          </div>
          <div class="alert ok" id="notesOk" role="status">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª âœ…</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ========== Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª ========== -->
  <section id="skills" class="card">
    <h3>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h3>
    <div class="skills" id="skillsList"></div>
  </section>

  <!-- ========== Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ========== -->
  <section id="assignments" class="card">
    <h3>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¨ÙŠØªÙŠØ©</h3>
    <form id="assignForm" class="slot" novalidate>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input id="asgTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø¬Ø¨ (Ù…Ø«Ø§Ù„: Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙØ­Ø© 12)" required minlength="3" style="flex:2;min-width:260px">
        <input id="asgDue" type="date" style="flex:1;min-width:180px">
        <input id="asgLink" placeholder="Ø±Ø§Ø¨Ø· ØªÙˆØ¶ÙŠØ­ÙŠ (HTTPS ÙÙ‚Ø·)" inputmode="url">
        <button class="btn primary" type="submit">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="btn ghost" id="clearAsg" type="button">Ø­Ø°Ù Ø§Ù„ÙƒÙ„</button>
      </div>
      <div class="alert error" id="asgErr" role="alert"></div>
    </form>
    <div class="activities" id="asgList" aria-live="polite"></div>
  </section>

  <!-- ========== Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ù†Ù‚Ø§Ø· ========== -->
  <section id="behavior" class="card">
    <h3>Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª</h3>
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted">Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ù‚Ø§Ø·</div>
        <div style="font-size:2rem;font-weight:900;color:var(--ok)" id="points">0</div>
      </div>
      <div class="row">
        <button class="btn ok" id="pPlus5">+5</button>
        <button class="btn ok" id="pPlus1">+1</button>
        <button class="btn warn" id="pMinus1">-1</button>
        <button class="btn danger" id="pReset">ØªØµÙÙŠØ±</button>
      </div>
    </div>
    <div class="row" style="margin-top:10px;gap:8px;flex-wrap:wrap">
      <select id="rewardSel">
        <option value="">Ø§Ø®ØªØ± Ù…ÙƒØ§ÙØ£Ø© Ù„Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</option>
        <option value="Ù…Ù„ØµÙ‚ Ø°Ù‡Ø¨ÙŠ|5">Ù…Ù„ØµÙ‚ Ø°Ù‡Ø¨ÙŠ (5)</option>
        <option value="ÙˆØ³Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©|10">ÙˆØ³Ø§Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (10)</option>
        <option value="Ø´Ù‡Ø§Ø¯Ø© Ù†Ø¬Ù… Ø§Ù„ØµÙ|15">Ø´Ù‡Ø§Ø¯Ø© Ù†Ø¬Ù… Ø§Ù„ØµÙ (15)</option>
      </select>
      <button class="btn primary" id="redeemBtn">Ø§Ø³ØªØ¨Ø¯Ø§Ù„</button>
      <span class="pill" id="lastRedeem">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
    </div>
  </section>

  <!-- ========== Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ========== -->
  <section id="report" class="card">
    <h3>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©</h3>
    <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <input id="reportMonth" placeholder="Ø§Ù„Ø´Ù‡Ø± (Ù…Ø«Ø§Ù„: Ù…Ø­Ø±Ù… 1447Ù‡Ù€)">
      <button class="btn primary" id="genReport">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      <button class="btn ghost" id="printBtn">Ø·Ø¨Ø§Ø¹Ø©</button>
      <button class="btn" id="exportBtn" title="Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ">ØªØµØ¯ÙŠØ± JSON</button>
      <label class="btn" for="importFile" style="cursor:pointer">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button class="btn danger" id="factoryReset" title="Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø´Ø§Ù…Ù„Ø©</button>
    </div>
    <pre id="reportOut"></pre>
    <div class="alert ok" id="impOk" role="status">ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‘</div>
    <div class="alert error" id="impErr" role="alert">ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯â€”ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ù„Ù.</div>
  </section>

  <div class="footer">Â© Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ 1447Ù‡Ù€ â€” Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</div>
</main>

<script>
/* ==========================================================
   âœ… Ø£Ù…Ø§Ù†/Ø£Ø¯Ø§Ø¡:
   - escapeHTML Ù„Ù…Ù†Ø¹ XSS
   - safeURL ÙŠÙ‚Ø¨Ù„ HTTPS ÙÙ‚Ø·
   - ÙØ­Øµ JSON Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
   - Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ø¹Ø¨Ø± localStorage
   ========================================================== */

/* ======= Ø«ÙˆØ§Ø¨Øª ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ======= */
const DAYS = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];
const DEFAULT_SKILLS = [
  {id:'read-letters',  title:'ØªØ¹Ø±Ù Ø§Ù„Ø­Ø±ÙˆÙ Ø§Ù„Ù‡Ø¬Ø§Ø¦ÙŠØ©', area:'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©'},
  {id:'read-words3',   title:'Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ„Ù…Ø§Øª Ø«Ù„Ø§Ø«ÙŠØ©', area:'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©'},
  {id:'write-letters', title:'ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø­Ø±ÙˆÙ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­', area:'Ø§Ù„ÙƒØªØ§Ø¨Ø©'},
  {id:'write-name',    title:'ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„Ù‹Ø§', area:'Ø§Ù„ÙƒØªØ§Ø¨Ø©'},
  {id:'count-20',      title:'Ø¹Ø¯Ù‘ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø­ØªÙ‰ 20', area:'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª'},
  {id:'add-10',        title:'Ø¬Ù…Ø¹ Ø­ØªÙ‰ 10', area:'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª'},
  {id:'behavior',      title:'Ø³Ù„ÙˆÙƒ Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙ', area:'Ø§Ù„Ø³Ù„ÙˆÙƒ'},
  {id:'team',          title:'Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ù†Ø´Ø§Ø· Ø¬Ù…Ø§Ø¹ÙŠ', area:'Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©'},
];
const LS = { student:'g1_student', skills:'g1_skills', table:'g1_table', notes:'g1_notes', asg:'g1_assign', points:'g1_points' };

/* ======= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ======= */
const $=q=>document.querySelector(q);
const fmtDate = d => new Intl.DateTimeFormat('ar-SA',{dateStyle:'medium',timeStyle:'short'}).format(d);
const fmtHijri = d => {
  try{ return new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura',{dateStyle:'full'}).format(d); }
  catch(_){ return 'Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ù‡Ø¬Ø±ÙŠ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­'; }
};
const escapeHTML = (s='')=> s.replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
const uuidv4 = ()=> (crypto.randomUUID ? crypto.randomUUID() : ('id-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2)));
const safeURL = (u)=>{
  try{
    if(!u) return '';
    const url = new URL(u);
    // ğŸ”’ Ù‚Ø¨ÙˆÙ„ HTTPS ÙÙ‚Ø·
    if(url.protocol === 'https:') return url.href;
  }catch(_){}
  return '';
};

/* ======= Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ======= */
let state = {
  student:{name:'',img:''},
  skills:{},  // id -> bool
  table:{},   // day -> [5]
  notes:{},   // day -> text
  asg:[],     // {id,title,due,link,at,done}
  points:0
};

/* ======= ØªØ­Ù…ÙŠÙ„/Ø­ÙØ¸ ======= */
function loadAll(){
  try{
    state.student = JSON.parse(localStorage.getItem(LS.student)||'{}');
    state.skills  = JSON.parse(localStorage.getItem(LS.skills)||'{}') || {};
    state.table   = JSON.parse(localStorage.getItem(LS.table) || '{}') || {};
    state.notes   = JSON.parse(localStorage.getItem(LS.notes) || '{}') || {};
    state.asg     = JSON.parse(localStorage.getItem(LS.asg)   || '[]') || [];
    const p       = JSON.parse(localStorage.getItem(LS.points)||'0');
    state.points  = Number.isFinite(p)?p:0;
  }catch(e){ console.error('load',e); }
}
function persist(){
  localStorage.setItem(LS.student, JSON.stringify(state.student));
  localStorage.setItem(LS.skills , JSON.stringify(state.skills));
  localStorage.setItem(LS.table  , JSON.stringify(state.table));
  localStorage.setItem(LS.notes  , JSON.stringify(state.notes));
  localStorage.setItem(LS.asg    , JSON.stringify(state.asg));
  localStorage.setItem(LS.points , JSON.stringify(state.points));
}

/* ======= Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ/Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ ======= */
(function renderToday(){
  const now = new Date();
  $('#todayLine').textContent = `${fmtHijri(now)} â€” ${fmtDate(now)}`;
})();

/* ======= Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ======= */
function renderStudent(){
  $('#studentName').value = state.student.name || '';
  $('#studentImg').value  = state.student.img || '';
  $('#avatar').src        = state.student.img ? safeURL(state.student.img) : 'https://i.imgur.com/2yaf2wb.png';
  updateSkillProgress();
}
$('#saveStudent').addEventListener('click', ()=>{
  const name = $('#studentName').value.trim();
  const img  = $('#studentImg').value.trim();
  const err  = $('#errBox'); err.classList.remove('show'); err.textContent='';
  if(name.length<2){ err.textContent='âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ (Ø­Ø±ÙØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).'; err.classList.add('show'); return; }
  if(img && !safeURL(img)){ err.textContent='âš ï¸ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† HTTPS ØµØ§Ù„Ø­Ù‹Ø§.'; err.classList.add('show'); return; }
  state.student = {name, img:safeURL(img)};
  persist(); $('#saveOk').style.display='inline-block';
  setTimeout(()=> $('#saveOk').style.display='none', 1400);
});

/* ======= Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ ======= */
function renderTable(){
  const tb = $('#tableBody'); tb.innerHTML='';
  DAYS.forEach(day=>{
    const tr = document.createElement('tr');
    const th = document.createElement('th'); th.textContent = day; tr.appendChild(th);
    for(let i=0;i<5;i++){
      const td = document.createElement('td');
      const inp = document.createElement('input');
      inp.setAttribute('aria-label', `Ø­ØµØ© ${i+1} ÙŠÙˆÙ… ${day}`);
      inp.value = (state.table[day]?.[i]) || '';
      inp.maxLength = 40;
      inp.addEventListener('input', ()=>{
        if(!state.table[day]) state.table[day]=Array(5).fill('');
        state.table[day][i] = inp.value;
        persist();
      });
      td.appendChild(inp); tr.appendChild(td);
    }
    tb.appendChild(tr);
  });
}
/* Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ… */
function renderNotesUI(){ $('#dayNotes').value = state.notes[$('#daySelect').value] || ''; }
$('#daySelect').addEventListener('change', renderNotesUI);
$('#saveNotes').addEventListener('click', ()=>{
  const d = $('#daySelect').value;
  state.notes[d] = $('#dayNotes').value.slice(0,500);
  persist(); $('#notesOk').classList.add('show'); setTimeout(()=>$('#notesOk').classList.remove('show'),1200);
});
$('#clearNotes').addEventListener('click', ()=>{
  const d = $('#daySelect').value;
  state.notes[d] = ''; persist(); renderNotesUI();
});

/* ======= Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª ======= */
function renderSkills(){
  const box = $('#skillsList'); box.innerHTML='';
  DEFAULT_SKILLS.forEach(s=>{
    const wrap = document.createElement('div');
    wrap.className='skill';
    const left = document.createElement('div');
    const strong = document.createElement('strong'); strong.textContent = s.title;
    const meta = document.createElement('div'); meta.className='muted'; meta.textContent = s.area;
    left.appendChild(strong); left.appendChild(meta);
    const label = document.createElement('label'); label.className='row'; label.style.gap='6px';
    const span  = document.createElement('span'); span.className='muted'; span.textContent='ØªÙ… Ø§Ù„Ø¥ØªÙ‚Ø§Ù†';
    const check = document.createElement('input'); check.type='checkbox'; check.dataset.skill=s.id; check.checked=!!state.skills[s.id];
    check.addEventListener('change',()=>{
      state.skills[s.id]=check.checked; persist(); updateSkillProgress();
    });
    label.appendChild(span); label.appendChild(check);
    wrap.appendChild(left); wrap.appendChild(label); box.appendChild(wrap);
  });
  updateSkillProgress();
}
function updateSkillProgress(){
  const total = DEFAULT_SKILLS.length;
  const done  = DEFAULT_SKILLS.filter(s=> state.skills[s.id]).length;
  const pct   = total? Math.round(done*100/total):0;
  $('#skillPct').textContent = pct; $('#progressBar').style.width = pct+'%';
}

/* ======= Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª ======= */
function renderAsg(){
  const box = $('#asgList'); box.innerHTML='';
  if(!state.asg.length){
    const empty = document.createElement('div'); empty.className='tile';
    empty.innerHTML = `<div class="ph">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ§Ø¬Ø¨Ø§Øª</div><div class="body muted">Ø£Ø¶Ù ÙˆØ§Ø¬Ø¨Ù‹Ø§ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰.</div>`;
    box.appendChild(empty); return;
  }
  state.asg.slice().sort((a,b)=> (a.done===b.done? (a.due-b.due) : (a.done?1:-1))).forEach(a=>{
    const wrap = document.createElement('div'); wrap.className='tile';
    const top = document.createElement('div'); top.className='ph';
    if(a.link){ const link = document.createElement('a'); link.href=safeURL(a.link); link.target='_blank'; link.rel='noopener noreferrer'; link.textContent='Ø±Ø§Ø¨Ø· ØªÙˆØ¶ÙŠØ­ÙŠ'; top.appendChild(link); }
    else { top.textContent='Ø¨Ø¯ÙˆÙ† Ø±Ø§Ø¨Ø·'; }
    const body = document.createElement('div'); body.className='body';
    const title = document.createElement('strong'); title.textContent=a.title;
    const meta = document.createElement('div'); meta.className='meta';
    const left = document.createElement('span'); left.textContent = 'Ø§Ù„ØªØ³Ù„ÙŠÙ…: ' + (a.due? new Date(a.due).toLocaleDateString('ar-SA') : 'â€”');
    const right= document.createElement('span'); right.textContent = a.done?'âœ… Ù…Ù†Ø¬Ø²':'â³ Ø¬Ø§Ø±ÙŠ';
    meta.appendChild(left); meta.appendChild(right);

    const actions = document.createElement('div'); actions.className='row'; actions.style.justifyContent='space-between';
    const btnDone = document.createElement('button'); btnDone.className='btn ok'; btnDone.textContent = a.done?'ØªØ±Ø§Ø¬Ø¹':'ÙˆØ¶Ø¹ Ù…Ù†Ø¬Ø²';
    const btnGive = document.createElement('button'); btnGive.className='btn ghost'; btnGive.textContent = '+1 Ù†Ù‚Ø·Ø©';
    const btnDel  = document.createElement('button'); btnDel.className='btn danger'; btnDel.textContent = 'Ø­Ø°Ù';
    btnDone.addEventListener('click',()=>{ a.done=!a.done; persist(); renderAsg(); });
    btnGive.addEventListener('click',()=> addPoints(1));
    btnDel .addEventListener('click',()=>{ state.asg = state.asg.filter(x=>x.id!==a.id); persist(); renderAsg(); });
    actions.appendChild(btnDone); actions.appendChild(btnGive); actions.appendChild(btnDel);

    body.appendChild(title); body.appendChild(meta); body.appendChild(actions);
    wrap.appendChild(top); wrap.appendChild(body); box.appendChild(wrap);
  });
}
$('#assignForm').addEventListener('submit',(e)=>{
  e.preventDefault();
  const title = $('#asgTitle').value.trim();
  const dueVal= $('#asgDue').value;
  const link  = $('#asgLink').value.trim();
  const err   = $('#asgErr'); err.classList.remove('show'); err.textContent='';
  if(title.length<3){ err.textContent='âš ï¸ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙˆØ§Ø¬Ø¨ Ù‚ØµÙŠØ±.'; err.classList.add('show'); return; }
  if(link && !safeURL(link)){ err.textContent='âš ï¸ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† HTTPS ØµØ§Ù„Ø­Ù‹Ø§.'; err.classList.add('show'); return; }
  const item = {id:uuidv4(), title, due: dueVal? new Date(dueVal).getTime(): null, link:safeURL(link), at:Date.now(), done:false};
  state.asg.push(item); persist();
  ['#asgTitle','#asgDue','#asgLink'].forEach(q=> $(q).value='');
  renderAsg();
});
$('#clearAsg').addEventListener('click',()=>{
  if(confirm('Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§ØªØŸ')){ state.asg=[]; persist(); renderAsg(); }
});

/* ======= Ø§Ù„Ø³Ù„ÙˆÙƒ ÙˆØ§Ù„Ù…ÙƒØ§ÙØ¢Øª ======= */
function renderPoints(){ $('#points').textContent = state.points; }
function addPoints(n){ state.points = Math.max(0, state.points + n); persist(); renderPoints(); }
$('#pPlus5').addEventListener('click',()=>addPoints(5));
$('#pPlus1').addEventListener('click',()=>addPoints(1));
$('#pMinus1').addEventListener('click',()=>addPoints(-1));
$('#pReset').addEventListener('click',()=>{ if(confirm('ØªØ£ÙƒÙŠØ¯ ØªØµÙÙŠØ± Ø§Ù„Ù†Ù‚Ø§Ø·ØŸ')){ state.points=0; persist(); renderPoints(); }});
$('#redeemBtn').addEventListener('click',()=>{
  const v = $('#rewardSel').value; if(!v) return;
  const [name,costStr] = v.split('|'); const cost = Number(costStr||0);
  if(state.points < cost){ alert('Ø§Ù„Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ©.'); return; }
  state.points -= cost; persist(); renderPoints();
  $('#lastRedeem').textContent = `${name} â€“ ${fmtDate(new Date())}`;
});

/* ======= Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±/Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ/Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· ======= */
$('#genReport').addEventListener('click',()=>{
  const month = $('#reportMonth').value.trim() || 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (1447Ù‡Ù€)';
  const skillsDone = DEFAULT_SKILLS.filter(s=> state.skills[s.id]).map(s=>'â€¢ '+s.title).join('\n');
  const recentAsg  = state.asg.slice().sort((a,b)=>b.at-a.at).slice(0,5).map(a=>{
    const due = a.due? new Date(a.due).toLocaleDateString('ar-SA'):'â€”';
    return `â€¢ ${a.title} (Ø§Ù„ØªØ³Ù„ÙŠÙ…: ${due}) ${a.done?'âœ…':''}`;
  }).join('\n');
  const txt =
`ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ 1447Ù‡Ù€
Ø§Ù„Ø·Ø§Ù„Ø¨: ${state.student.name || 'â€”'}
Ø§Ù„Ø´Ù‡Ø±: ${month}

Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${state.points}

Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªÙ‚Ù†Ø© (${DEFAULT_SKILLS.filter(s=> state.skills[s.id]).length}/${DEFAULT_SKILLS.length}):
${skillsDone || 'â€”'}

Ø£Ø¨Ø±Ø² Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©:
${recentAsg || 'â€”'}

Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:
- ØªØ¹Ø²ÙŠØ² Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© 10 Ø¯Ù‚Ø§Ø¦Ù‚.
- ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©.
- Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø¨ÙŠ Ø¨Ù†Ù‚Ø§Ø·.`;
  $('#reportOut').textContent = txt;
});
$('#printBtn').addEventListener('click',()=>window.print());

$('#exportBtn').addEventListener('click',()=>{
  const name = (state.student.name || 'student').replace(/\s+/g,'-');
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download=`backup-grade1-1447-${name}.json`;
  a.click(); URL.revokeObjectURL(a.href);
});

$('#importFile').addEventListener('change', async (e)=>{
  const ok=$('#impOk'), err=$('#impErr'); ok.classList.remove('show'); err.classList.remove('show');
  try{
    const f=e.target.files?.[0]; if(!f) return;
    const text = await f.text();
    const data = JSON.parse(text);

    // âœ… ÙØ­Øµ Ø´ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    if(typeof data!=='object' || data===null) throw new Error('format');
    if(!('student' in data) || !('points' in data) || !('asg' in data) || !('skills' in data))
      throw new Error('missing');

    // Ø¯Ù…Ø¬ Ø¢Ù…Ù† Ù…Ø¹ Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    state = Object.assign({student:{},skills:{},table:{},notes:{},asg:[],points:0}, data);
    persist();
    renderAll(); ok.classList.add('show');
  }catch(ex){ console.error(ex); err.classList.add('show'); }
  finally{ e.target.value=''; }
});

$('#factoryReset').addEventListener('click',()=>{
  if(!confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) return;
  localStorage.removeItem(LS.student);
  localStorage.removeItem(LS.skills);
  localStorage.removeItem(LS.table);
  localStorage.removeItem(LS.notes);
  localStorage.removeItem(LS.asg);
  localStorage.removeItem(LS.points);
  state={student:{name:'',img:''},skills:{},table:{},notes:{},asg:[],points:0};
  renderAll();
});

/* ======= ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ ======= */
function renderAll(){ renderStudent(); renderTable(); renderNotesUI(); renderSkills(); renderAsg(); renderPoints(); }
loadAll(); renderAll();

/* ØªØ­Ø³ÙŠÙ† ØµØºÙŠØ±: Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§ */
document.addEventListener('click',(e)=>{
  if(!e.target.closest('.alert')) document.querySelectorAll('.alert.show').forEach(x=>x.classList.remove('show'));
});
</script>
</body>
</html>
